<html>
  <head>
    <title>Ice Cream Picker</title>
    <meta charset="utf-8">
		<link rel="stylesheet" href="https://pyscript.net/releases/2023.03.1/pyscript.css" />
		<script defer src="https://pyscript.net/releases/2023.03.1/pyscript.js"></script>
    <link rel="stylesheet" href="index.css" />
    <link rel="stylesheet" href="rightbar.css" />
  </head>
  <body>

    <py-config>
      packages = ["matplotlib", "pandas", "hypothesis"]
    </py-config>
    <!-- tried to do it as pyscript/examplestoga/static/css but not sure if this is the best idea-->
    <nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark" style="background-color: #000000">
        <div class="container">
            <a class="navbar-brand">
              DataFrame Trainer
            </a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExample07" aria-controls="navbarsExample07" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler icon"></span>
          </button>
        </div>
    </nav>

    <!--todo: make this challenges dynamic-->
    <script>
      http_call = () => {
          let req = new XMLHttpRequest();
          req.open('GET', 'http://127.0.0.1:5000/challenges/10/', false);
          req.send(null);
          let k = JSON.parse(req.responseText);
          let field = document.getElementById("field");
          let stringified = k.response;
          field.innerHTML = JSON.stringify(stringified);
          return stringified
      };
      reset_dev_console = () => {
        document.getElementsByClassName("py-terminal")[0].innerHTML = ''
      };
    </script>
    <py-script>
      import pandas as pd
      import numpy as np
      import hypothesis

      from hypothesis.extra.pandas import data_frames, column, range_indexes, series
      from hypothesis.extra.numpy import arrays
      import hypothesis.strategies as st


      class TransformWithConditions():
          # todo: this is not optimal, but it works for now
          # things to improve:
          #   - use one of the strategies from hypothesis.extra.pandas to generate the whole df, don't use pd.concat
          #   - length of the df should be variable
          #   - np.nan should be generated in the value column, but this is not possible if one specifies min and max values
          @staticmethod
          def initial() -> pd.DataFrame:
              df = data_frames(
                  columns=[
                      column("group", dtype=np.dtype(str)),
                      column("value", dtype=np.dtype(float)),
                  ],
                  rows=st.tuples(
                      st.sampled_from(["A", "B"]),
                      st.floats(min_value=0.0, max_value=10.0, width=16),
                  ),
                  index=range_indexes(min_size=25, max_size=25),
              ).example()
              srs = pd.Series(
                  arrays(
                      dtype=np.dtype(int),
                      shape=(25),
                      elements=st.integers(min_value=1, max_value=25),
                      unique=True,
                  ).example(),
                  name="ID",
                  dtype=np.dtype(int),
              )
              return pd.concat([srs, df], axis=1)

          @staticmethod
          def transform(df: pd.DataFrame) -> pd.DataFrame:
              df["value"] = df.groupby("group")["value"].transform(
                  lambda x: x.mask(x < 3).ffill().fillna(x.mean())
              )
              return df

          @staticmethod
          def static_example() -> pd.DataFrame:
              return pd.DataFrame(
                  {
                      "ID": list(range(1, 21)),
                      "group": ["A"] * 10 + ["B"] * 10,
                      "value": [
                          4,
                          6,
                          2,
                          9,
                          7,
                          5,
                          1,
                          9,
                          8,
                          9,
                          np.nan,
                          4,
                          5,
                          6,
                          1,
                          2,
                          3,
                          4,
                          2,
                          6,
                      ],
                  }
              )

          @staticmethod
          def expected_static() -> pd.DataFrame:
              return pd.DataFrame(
                  [
                      [1, "A", 4.000000],
                      [2, "A", 6.000000],
                      [3, "A", 6.000000],
                      [4, "A", 9.000000],
                      [5, "A", 7.000000],
                      [6, "A", 5.000000],
                      [7, "A", 5.000000],
                      [8, "A", 9.000000],
                      [9, "A", 8.000000],
                      [10, "A", 9.000000],
                      [11, "B", 3.666667],
                      [12, "B", 4.000000],
                      [13, "B", 5.000000],
                      [14, "B", 6.000000],
                      [15, "B", 6.000000],
                      [16, "B", 6.000000],
                      [17, "B", 3.000000],
                      [18, "B", 4.000000],
                      [19, "B", 4.000000],
                      [20, "B", 6.000000],
                  ],
                  columns=["ID", "group", "value"],
              )
    </py-script>

    <py-script>
      import pandas as pd
      import json
      from js import http_call

      def call_http_convert():
        global df
        global df_expected
        dictionary = http_call()
        response = dictionary.to_py()
        df = pd.DataFrame(json.loads(response["static_example"]))
        df_expected = pd.DataFrame(json.loads(response["expected_static"]))
        display_df(df, "pandas-output-input")
        display_df(df_expected, "pandas-output-expected")

      def display_df(df_t, element):
        Element(element + "-inner").element.innerHTML = ""
        Element(element).element.style.display = "block"
        display(df_t, target=element + "-inner", append="False")

      def log(message):
        # log to pyscript dev console
        print(message)

        # log to JS console
        js.console.log (message)

      def reset_inner_html():
        Element("pandas-dev-console-inner").element.innerHTML = ""

      def test_solution():
        print("running test solution")
        global df
        print(globals()['solution'](df))

      def test_solution_class():
        import pandas.testing as tm
        print("running test solution class")
        challenge = TransformWithConditions()
        df = challenge.initial()
        df_result = challenge.transform(df)
        df_result_user = globals()['solution'](df)
        print("after df_result_user")
        print(df_result_user)
        try:
          tm.assert_frame_equal(df_result, df_result_user)
        except Exception as e:
          print(e)
    </py-script>
    <div class="gridlayout">
      <div class="leftbar">
        <button type="button" id="other2" py-onClick="call_http_convert()">Get Example</button>
        <button type="button" id="reset" onClick="reset_dev_console()">Reset Console</button>
        <button type="button" id="reset2" py-onClick="test_solution()">Something</button>
        <button type="button" id="reset3" py-onClick="test_solution_class()">Test Solution Class</button>

        <label id="field" for="vname">Vorname:</label>
        <div id="pandas-repl">
            <h3>Python REPL</h3>
            <py-repl id="pandas-repl-inner">
              import pandas as pd

              # df and df_expected are already defined
              print(df)
              
            </py-repl>
        </div>
        <div id="pandas-dev-console">
            <h3>Dev Console</h3>
            <py-terminal id="pandas-dev-console-inner"></py-terminal>
        </div>
      </div>

      <div class="rightbar">
        <div id="challenge-description">
          <h3>Challenge Description</h3>
          <div id="challenge-description"></div>
        </div>
        <div id="pandas-output-input">
            <h3>Input</h3>
            <div id="pandas-output-input-inner"></div>
        </div>
        <div id="pandas-output-expected">
            <h3>Expected</h3>
            <div id="pandas-output-expected-inner"></div>
        </div>
      </div>
    </div>
  </body>
</html>
